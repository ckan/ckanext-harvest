{% extends "page.html" %}

{%- block title -%}Harvesting Sources{% endblock %}

{% block styles %}
    {{ super() }}
    {% resource 'ckanext-harvest/ckanext/harvest/style.css' %}
{% endblock %}

{% block primary_content %}

  <h1>Harvesting Sources</h1>

  {% if c.status %}
    <h3>Status:</h3>
    {{ c.status }}
  {% endif %}

  <div id="new-harvest-source"><a href="harvest/new">Add a harvesting source</a></div>
    {% if c.sources %}

      <table id="harvest-sources" class="table table-bordered table-condensed {% if c.publisher_auth %}publishers{% endif %}" >
        <tr>
          <th class="action">View</th>
          <th class="action">Edit</th>
          <th class="action">Refresh</th>
          <th>URL</th>
          <th>Type</th>
          <th>Active</th>
          <th>Statistics</th>
          <th>Next Harvest</th>
          <th>Created</th>
        </tr>
        {% set old_publisher = None %}
        {% for source in c.sources %}
          <tr class="publisher" py:if="c.publisher_auth and old_publisher != source['publisher_id']">
            {% if source.get('publisher_title') %}
              <td colspan="9">{{ source['publisher_title'] }}</td>
            {% else %}
              <td colspan="9">{{ source['publisher_id'] }}</td>
            {% endif %}
          </tr>
          {% set old_publisher = source['publisher_id'] %}
          <tr class="{% if source.active %}active{% else %}inactive{% endif %}">
            <td>
              <a href="harvest/{{ source.id }}" title="View" class="harvest-button harvest-view-button">
              </a>
            </td>
            <td>
              <a href="harvest/edit/{{ source.id }}" title="Edit" class="harvest-button harvest-edit-button">
              </a>
            </td>
            <td>
              <a href="harvest/refresh/{{ source.id }}" title="Refresh" class="harvest-button harvest-refresh-button">
              </a>
            </td>
        <td title="{{ source.url }}">{{ source.url|truncate }}</td>
        <td>{{ source.type }}</td>
        <td class="state">{{ source.active }}</td>
        {% if 'msg' in source.status %}
          <td>{{ source.status.msg }}</td>
          <td>{{ source.status.msg }}</td>
        {% else %}
          <td>Datasets: 
            <a href="harvest/{{ source.id }}#datasets">
              {{ source.status.overall_statistics.added }}
            </a> <br/>
            Last errors:
            <a href="harvest/{{ source.id }}#errors">
              {{source.status.last_harvest_statistics.errors}}
            </a>
          </td>
          <td>{{ source.status.next_harvest }}</td>
        {% endif %}

        <td>{{ source.created }}</td>
       </tr>
     {% endfor %}
  </table>
  {% else %}
    <div id="no-harvest-sources">No harvest sources defined yet.</div>
  {% endif %}
{% endblock %}